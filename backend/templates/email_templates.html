<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Email Templates</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    :root {
      --pastel-blue: #eaf6ff;
      --blue-100: #d7efff;
      --blue-200: #c4e7ff;
      --blue-300: #a7dbff;
      --ink: #1f2a44;
      --ink-soft: #64748b;
      --white: #ffffff;
      --border: #d9e2ec;
      --shadow: 0 10px 30px rgba(15, 23, 42, 0.10);

      --radius-lg: 18px;
      --radius-md: 12px;
      --radius-sm: 8px;

      --editable-bg: #f0f9ff;
      --editable-text: #0f172a;
      --editable-focus-bg: #dbeafe;
    }

    /* Dark mode */
    [data-theme="dark"] {
      --pastel-blue: #1e293b;
      --blue-100: #334155;
      --blue-200: #475569;
      --blue-300: #64748b;
      --ink: #f1f5f9;
      --ink-soft: #cbd5e1;
      --white: #1e293b;
      --border: #334155;
      --shadow: 0 6px 14px rgba(0,0,0,0.4);
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
      background: radial-gradient(circle at top left, var(--blue-100), var(--pastel-blue));
      color: var(--ink);
      min-height: 100vh;
    }

    /* Top Tabs */
    .tabs {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 14px 20px;
      background: var(--white);
      border-bottom: 1px solid var(--border);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .tab {
      text-decoration: none;
      color: var(--ink);
      background: var(--pastel-blue);
      border-radius: 999px;
      padding: 7px 14px;
      border: 1px solid var(--border);
      font-weight: 600;
      transition: 0.15s ease;
    }

    .tab:hover {
      background: var(--blue-200);
      transform: translateY(-1px);
    }

    .tab.active {
      background: var(--blue-300);
      color: var(--white);
    }

    .theme-toggle {
      padding: 7px 14px;
      background: var(--pastel-blue);
      border: 1px solid var(--border);
      border-radius: 999px;
      cursor: pointer;
      font-weight: bold;
      display: flex;
      align-items: center;
    }

    .shell {
      max-width: 1100px;
      margin: 26px auto;
      padding: 0 20px 40px;
    }

    .card {
      background: var(--white);
      padding: 24px;
      border-radius: 24px;
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
    }

    .grid {
      display: grid;
      grid-template-columns: 260px 1fr;
      gap: 20px;
    }

    .tones {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .tone {
      padding: 9px 14px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: var(--white);
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      transition: 0.12s ease;
    }

    .tone:hover {
      transform: translateY(-1px);
      background: var(--blue-200);
    }

    .tone.active {
      background: var(--blue-300);
      color: white;
    }

    .preview {
      background: var(--white);
      padding: 18px;
      border: 1px solid var(--border);
      border-radius: 20px;
      box-shadow: var(--shadow);
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .preview-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .preview-title {
      font-size: 18px;
      font-weight: bold;
    }

    .preview-chip {
      padding: 4px 10px;
      background: var(--blue-100);
      border-radius: 10px;
      border: 1px solid var(--blue-200);
      font-size: 11px;
    }

    /* Email body + fields */
    .email-fields {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .email-row {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .email-label {
      width: 70px;
      font-weight: bold;
      color: var(--ink-soft);
    }

    .email-input {
      flex: 1;
      padding: 7px 10px;
      border-radius: 8px;
      border: 1px solid var(--border);
    }

    .subject-chips {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      margin-left: 70px;
    }

    .subject-chip {
      background: var(--blue-100);
      padding: 3px 8px;
      border-radius: 10px;
      border: 1px solid var(--blue-200);
      cursor: pointer;
      font-size: 11px;
    }

    /* Formatting toolbar */
    .format-toolbar {
      display: flex;
      gap: 8px;
      margin-bottom: 8px;
    }

    .btn {
      border-radius: 999px;
      padding: 7px 14px;
      border: none;
      cursor: pointer;
      font-weight: 600;
      box-shadow: var(--shadow);
    }

    .btn-ghost {
      background: var(--pastel-blue);
      border: 1px solid var(--border);
    }

    .btn-primary {
      background: #2563eb;
      color: white;
    }

    /* Saved templates */
    .saved-bar {
      margin-top: 8px;
      padding: 8px;
      border: 1px dashed var(--border);
      border-radius: 12px;
      background: rgba(148,163,184,0.10);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    #email-body {
      margin-top: 6px;
      line-height: 1.55;
    }
    /* ===== Editable Placeholder Enhancements ===== */

/* Highlight empty placeholders */
[contenteditable][data-placeholder]:empty {
  background: var(--editable-bg);
  padding: 2px 6px;
  border-radius: 6px;
}

/* Show placeholder text */
[contenteditable][data-placeholder]:empty::before {
  content: attr(data-placeholder);
  color: var(--ink-soft);
  font-style: italic;
  pointer-events: none;
}

/* Focus state */
[contenteditable][data-placeholder]:focus {
  background: var(--editable-focus-bg);
}

/* Hide placeholder text when focused */
[contenteditable][data-placeholder]:focus::before {
  content: "";
}

/* Warning highlight when copying */
.placeholder-warning {
  background: #fee2e2 !important;
  outline: 2px solid #f87171;
}

  </style>
</head>

<body>
<nav class="tabs">
  <div class="tabs-left">
    <a class="tab" href="{{ url_for('home') }}">Home</a>
    <a class="tab active" href="{{ url_for('email_templates') }}">Email Templates</a>
  </div>

  <button id="themeToggle" class="theme-toggle">
    üåô <span id="themeLabel">Dark Mode</span>
  </button>
</nav>

<main class="shell">
  <section class="card">
    <h1>Email Templates</h1>
    <p class="subtitle">
      Pick a tone, personalize the placeholders, then copy or save.
    </p>

    <details open>
      <summary>‚ñº Click here for additional templates</summary>

      <div class="grid">
        <!-- LEFT ‚Äî Tone picker -->
        <div class="tones">
          <!-- Search bar -->
          <input
            id="templateSearch"
            type="text"
            placeholder="Search templates..."
            style="padding:8px 12px;border-radius:10px;border:1px solid var(--border);margin-bottom:10px;"
          >

          <div class="tone active" data-tone="friendly"><span>Friendly</span><small>check-in</small></div>
          <div class="tone" data-tone="serious"><span>Serious</span><small>formal reminder</small></div>
          <div class="tone" data-tone="business"><span>Business</span><small>status update</small></div>
          <div class="tone" data-tone="reminder"><span>Reminder</span><small>quick ping</small></div>
          <div class="tone" data-tone="apology"><span>Apology</span><small>own mistake</small></div>
          <div class="tone" data-tone="thankyou"><span>Thank You</span><small>gratitude</small></div>
          <div class="tone" data-tone="motivational"><span>Motivational</span><small>encouragement</small></div>
          <div class="tone" data-tone="followup"><span>Follow-Up</span><small>second message</small></div>
          <div class="tone" data-tone="outreach"><span>Outreach</span><small>networking</small></div>
          <div class="tone" data-tone="delay"><span>Project Delay</span><small>notice</small></div>
          <div class="tone" data-tone="celebration"><span>Celebration</span><small>üéâ success</small></div>
        </div>

        <!-- RIGHT ‚Äî Preview panel -->
        <div class="preview">

          <!-- TITLE + TONE CHIP -->
          <div class="preview-header">
            <div>
              <div id="previewTitle" class="preview-title">Friendly Team Check-In</div>
              <div id="previewToneChip" class="preview-chip">Tone: Friendly</div>
            </div>
          </div>

          <!-- EMAIL FIELDS (To, Cc, Bcc, Subject) -->
          <div class="email-fields">
            <div class="email-row">
              <div class="email-label">To:</div>
              <input id="toField" class="email-input" type="email" placeholder="recipient@example.com">
              <button id="ccbccToggle" class="btn-ghost btn" style="padding:4px 10px;font-size:11px;">+Cc/Bcc</button>
            </div>

            <div id="extraFields" class="hidden">
              <div class="email-row">
                <div class="email-label">Cc:</div>
                <input id="ccField" class="email-input" type="text" placeholder="cc@example.com">
              </div>
              <div class="email-row">
                <div class="email-label">Bcc:</div>
                <input id="bccField" class="email-input" type="text" placeholder="bcc@example.com">
              </div>
            </div>

            <div class="email-row">
              <div class="email-label">Subject:</div>
              <input id="subjectField" class="email-input" type="text" placeholder="Enter subject here">
            </div>

            <!-- Dynamically generated subject chips -->
            <div id="subjectChips" class="subject-chips"></div>
          </div>

          <!-- FORMAT TOOLBAR (Bold, Italic, Underline, Lists) -->
          <div class="format-toolbar">
            <button class="btn-ghost btn format-btn" data-command="bold"><b>B</b></button>
            <button class="btn-ghost btn format-btn" data-command="italic"><i>I</i></button>
            <button class="btn-ghost btn format-btn" data-command="underline"><u>U</u></button>
            <button class="btn-ghost btn format-btn" data-command="insertUnorderedList">‚Ä¢ List</button>
            <button class="btn-ghost btn format-btn" data-command="insertOrderedList">1. List</button>
          </div>

          <!-- REWRITE DROPDOWN (must appear FIRST) -->
          <div style="margin-bottom:10px;">
            <label><strong>‚ú® Rewrite Email:</strong></label>
            <select id="rewriteSelect" style="margin-left:8px;padding:6px;border-radius:8px;border:1px solid var(--border);">
              <option value="">Select option‚Ä¶</option>
              <option value="formal">Make more formal</option>
              <option value="casual">Make more casual</option>
              <option value="shorter">Shorten email</option>
              <option value="longer">Expand email</option>
              <option value="clearer">Improve clarity</option>
              <option value="grammar">Fix grammar</option>
            </select>
            <button id="rewriteBtn" class="btn-ghost btn" style="margin-left:10px;">Rewrite</button>
          </div>

          <!-- IMPROVE CLARITY BUTTON -->
          <button id="clarityBtn" class="btn-ghost btn" style="margin-bottom:10px;border-radius:12px;">
            ‚ú® Improve Clarity
          </button>

          <!-- EMAIL BODY -->
          <div id="email-body"></div>

          <!-- SAVED TEMPLATES BAR -->
          <div class="saved-bar">
            <span style="font-weight:600;">Saved:</span>
            <select id="savedSelect" class="saved-select" style="padding:4px 10px;border-radius:10px;">
              <option value="">(none)</option>
            </select>
            <button id="saveCurrentBtn" class="btn-ghost btn">Save current</button>
            <button id="deleteSavedBtn" class="btn-ghost btn">Delete selected</button>
          </div>

          <!-- FOOTER BUTTONS -->
          <div class="preview-footer" style="display:flex;justify-content:space-between;align-items:center;margin-top:10px;">
            <div style="display:flex;gap:8px;">
              <button id="copyBtn" class="btn btn-primary">Copy Email</button>
              <button id="clearBtn" class="btn btn-ghost">Clear fields</button>
            </div>

            <div class="stats" style="display:flex;gap:8px;font-size:11px;color:var(--ink-soft);">
              <div id="templatesCount">Custom templates: 0</div>
              <div id="lastCopied">Last copied: ‚Äî</div>
            </div>
          </div>

        </div>
      </div>
    </details>

    <a class="tab" href="{{ url_for('home') }}" style="margin-top:20px;display:inline-block;">‚Üê Back to Home</a>
  </section>
</main>
<script>
/* ---------------------------------------
   TEMPLATE DEFINITIONS
--------------------------------------- */
const EXAMPLES = {
  friendly: {
    title: "Friendly Team Check-In",
    body: `Hi everyone,<br><br>
I hope you're all doing well! I wanted to check in regarding <span contenteditable="true" data-placeholder="[project name]"></span> for <span contenteditable="true" data-placeholder="[class name]"></span>, due on <span contenteditable="true" data-placeholder="[due date]"></span>.<br><br>
I've completed <span contenteditable="true" data-placeholder="[your completed task]"></span>, and I noticed we still need to finish <span contenteditable="true" data-placeholder="[remaining tasks]"></span>.<br><br>
Please let me know if there's anything I can help with.<br><br>
Sincerely,<br>
<span contenteditable="true" data-placeholder="[Your Name]"></span>`
  },

  serious: {
    title: "Formal Project Reminder",
    body: `Hello team,<br><br>
This is a reminder about our submission for <span contenteditable="true" data-placeholder="[project name]"></span> in <span contenteditable="true" data-placeholder="[course name]"></span>, due on <span contenteditable="true" data-placeholder="[due date]"></span>.<br><br>
Please ensure remaining tasks are completed by <span contenteditable="true" data-placeholder="[target date]"></span>.<br><br>
Best,<br>
<span contenteditable="true" data-placeholder="[Your Name]"></span>`
  },

  business: {
    title: "Business Status Update",
    body: `Dear Team,<br><br>
Here's a quick update on <span contenteditable="true" data-placeholder="[project name]"></span>. We completed <span contenteditable="true" data-placeholder="[milestone]"></span> and next we'll focus on <span contenteditable="true" data-placeholder="[next step]"></span>.<br><br>
Please confirm your availability for our next check-in on <span contenteditable="true" data-placeholder="[date/time]"></span>.<br><br>
Thanks,<br>
<span contenteditable="true" data-placeholder="[Your Name]"></span>`
  },

  reminder: {
    title: "Friendly Reminder",
    body: `Hi <span contenteditable="true" data-placeholder="[Name]"></span>,<br><br>
Just a quick reminder about <span contenteditable="true" data-placeholder="[event/task]"></span> happening on <span contenteditable="true" data-placeholder="[date/time]"></span>.<br><br>
Best,<br>
<span contenteditable="true" data-placeholder="[Your Name]"></span>`
  },

  apology: {
    title: "Apology Email",
    body: `Hi <span contenteditable="true" data-placeholder="[Name]"></span>,<br><br>
I sincerely apologize for <span contenteditable="true" data-placeholder="[issue]"></span>. I appreciate your patience and will ensure <span contenteditable="true" data-placeholder="[corrective action]"></span> moving forward.<br><br>
Thank you,<br>
<span contenteditable="true" data-placeholder="[Your Name]"></span>`
  },

  thankyou: {
    title: "Thank You Message",
    body: `Hi <span contenteditable="true" data-placeholder="[Name]"></span>,<br><br>
Thank you so much for <span contenteditable="true" data-placeholder="[specific help]"></span>. Your support made a huge difference.<br><br>
Best,<br>
<span contenteditable="true" data-placeholder="[Your Name]"></span>`
  },

  motivational: {
    title: "Motivational Boost",
    body: `Hi team,<br><br>
Just wanted to send some encouragement as we push toward <span contenteditable="true" data-placeholder="[milestone]"></span>.<br><br>
We've got this!<br><br>
‚Äî <span contenteditable="true" data-placeholder="[Your Name]"></span>`
  },

  followup: {
    title: "Follow-Up Email",
    body: `Hi <span contenteditable="true" data-placeholder="[Name]"></span>,<br><br>
I'm following up on <span contenteditable="true" data-placeholder="[topic]"></span>. Let me know when you get a chance!<br><br>
Thanks,<br>
<span contenteditable="true" data-placeholder="[Your Name]"></span>`
  },

  outreach: {
    title: "Outreach Email",
    body: `Hello,<br><br>
I'm reaching out because <span contenteditable="true" data-placeholder="[reason]"></span>.<br><br>
Best,<br>
<span contenteditable="true" data-placeholder="[Your Name]"></span>`
  },

  delay: {
    title: "Project Delay Notice",
    body: `Hi team,<br><br>
Due to <span contenteditable="true" data-placeholder="[delay reason]"></span>, our project timeline will shift.<br><br>
I'll send updates soon.<br><br>
‚Äî <span contenteditable="true" data-placeholder="[Your Name]"></span>`
  },

  celebration: {
    title: "Celebration Email üéâ",
    body: `Great work team!<br><br>
We successfully reached <span contenteditable="true" data-placeholder="[milestone]"></span> and I‚Äôm proud of everyone.<br><br>
Celebrate this win! üéâ<br><br>
‚Äî <span contenteditable="true" data-placeholder="[Your Name]"></span>`
  }
};

/* ---------------------------------------
   SUBJECT SUGGESTIONS
--------------------------------------- */
const SUBJECT_SUGGESTIONS = {
  friendly: ["Quick check-in", "Touching base", "Small update"],
  serious: ["Important deadline reminder", "Action needed", "Submission approaching"],
  business: ["Project status update", "Weekly update", "Next steps"],
  reminder: ["Friendly reminder", "Reminder about our meeting", "Quick reminder"],
  apology: ["Apologies", "I'm sorry about this", "Apology regarding issue"],
  thankyou: ["Thank you!", "Appreciation", "Thanks again"],
  motivational: ["You‚Äôve got this!", "Keep going", "Motivation boost"],
  followup: ["Following up", "Checking in again", "Second request"],
  outreach: ["Reaching out", "Quick introduction", "Request to connect"],
  delay: ["Timeline update", "Project delay notice", "Important schedule change"],
  celebration: ["We did it! üéâ", "Congrats team!", "Celebrating success"]
};

/* ---------------------------------------
   DOM ELEMENTS
--------------------------------------- */
const previewTitle = document.getElementById("previewTitle");
const previewToneChip = document.getElementById("previewToneChip");
const emailBody = document.getElementById("email-body");
const tones = document.querySelectorAll(".tone");

const subjectField = document.getElementById("subjectField");
const subjectChipsContainer = document.getElementById("subjectChips");

const toField = document.getElementById("toField");
const ccbccToggle = document.getElementById("ccbccToggle");
const extraFields = document.getElementById("extraFields");

const copyBtn = document.getElementById("copyBtn");
const clearBtn = document.getElementById("clearBtn");

const saveCurrentBtn = document.getElementById("saveCurrentBtn");
const deleteSavedBtn = document.getElementById("deleteSavedBtn");
const savedSelect = document.getElementById("savedSelect");

const templateSearch = document.getElementById("templateSearch");

/* ---------------------------------------
   DARK MODE
--------------------------------------- */
const themeToggle = document.getElementById("themeToggle");
const themeLabel = document.getElementById("themeLabel");

function applyTheme(theme) {
  if (theme === "dark") {
    document.documentElement.setAttribute("data-theme", "dark");
    themeLabel.textContent = "Light Mode";
    themeToggle.firstChild.textContent = "‚òÄÔ∏è";
  } else {
    document.documentElement.removeAttribute("data-theme");
    themeLabel.textContent = "Dark Mode";
    themeToggle.firstChild.textContent = "üåô";
  }
}

const savedTheme = localStorage.getItem("theme") || "light";
applyTheme(savedTheme);

themeToggle.addEventListener("click", () => {
  const newMode =
    document.documentElement.getAttribute("data-theme") === "dark"
      ? "light"
      : "dark";
  localStorage.setItem("theme", newMode);
  applyTheme(newMode);
});

/* ---------------------------------------
   TEMPLATE SWITCHING
--------------------------------------- */
function renderSubjectChips(toneKey) {
  subjectChipsContainer.innerHTML = "";
  (SUBJECT_SUGGESTIONS[toneKey] || []).forEach(text => {
    const chip = document.createElement("button");
    chip.className = "subject-chip";
    chip.textContent = text;
    chip.addEventListener("click", () => {
      subjectField.value = text;
    });
    subjectChipsContainer.appendChild(chip);
  });
}

function setTone(key) {
  const data = EXAMPLES[key];
  previewTitle.textContent = data.title;
  previewToneChip.textContent = "Tone: " + key.charAt(0).toUpperCase() + key.slice(1);
  emailBody.innerHTML = data.body;

  tones.forEach(t => t.classList.toggle("active", t.dataset.tone === key));
  renderSubjectChips(key);

  initEditablePlaceholders();
  enablePlaceholderTabbing();
  }


tones.forEach(tone =>
  tone.addEventListener("click", () => setTone(tone.dataset.tone))
);

setTone("friendly");

function initEditablePlaceholders() {
  emailBody.querySelectorAll('[contenteditable][data-placeholder]').forEach(el => {
    el.addEventListener('focus', () => {
      if (el.textContent.trim() === "") {
        el.innerHTML = "";
      }
    });

    el.addEventListener('blur', () => {
      if (el.textContent.trim() === "") {
        el.innerHTML = "";
      }
    });
  });
  function enablePlaceholderTabbing() {
  const placeholders = Array.from(
    emailBody.querySelectorAll('[contenteditable][data-placeholder]')
  );

  placeholders.forEach((el, index) => {
    el.addEventListener("keydown", (e) => {
      if (e.key === "Tab") {
        e.preventDefault();

        const dir = e.shiftKey ? -1 : 1;
        const next = placeholders[index + dir];

        if (next) {
          next.focus();

          const range = document.createRange();
          const sel = window.getSelection();
          range.selectNodeContents(next);
          range.collapse(false);
          sel.removeAllRanges();
          sel.addRange(range);
        }
      }
    });
  });
  function getUnfilledPlaceholders() {
  return Array.from(
    emailBody.querySelectorAll('[contenteditable][data-placeholder]')
  ).filter(el => el.textContent.trim() === "");
}

}

}


/* ---------------------------------------
   SEARCH BAR ‚Äî FILTER TEMPLATES
--------------------------------------- */
templateSearch.addEventListener("input", (e) => {
  const term = e.target.value.toLowerCase();
  tones.forEach(tone => {
    tone.style.display = tone.innerText.toLowerCase().includes(term)
      ? "flex"
      : "none";
  });
});

/* ---------------------------------------
   CC / BCC TOGGLE
--------------------------------------- */
ccbccToggle.addEventListener("click", () => {
  extraFields.classList.toggle("hidden");
  ccbccToggle.textContent = extraFields.classList.contains("hidden")
    ? "+Cc/Bcc"
    : "Hide Cc/Bcc";
});

/* ---------------------------------------
   FORMAT BUTTONS
--------------------------------------- */
document.querySelectorAll(".format-btn").forEach(btn => {
  btn.addEventListener("click", e => {
    e.preventDefault();
    document.execCommand(btn.dataset.command, false, null);
    emailBody.focus();
  });
});

/* ---------------------------------------
   IMPROVE CLARITY BUTTON
--------------------------------------- */
function improveClarity() {
  let text = emailBody.innerText;

  text = text.replace(/\breally\b/gi, "");
  text = text.replace(/\bvery\b/gi, "");
  text = text.replace(/I just wanted to/gi, "I wanted to");
  text = text.trim();

  emailBody.innerHTML = text.replace(/\n/g, "<br>");
}

document.getElementById("clarityBtn").addEventListener("click", improveClarity);

/* ---------------------------------------
   AI REWRITE FEATURE
--------------------------------------- */
document.getElementById("rewriteBtn").addEventListener("click", async () => {
  const mode = document.getElementById("rewriteSelect").value;
  if (!mode) {
    alert("Please select a rewrite option.");
    return;
  }

  const response = await fetch("/rewrite", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      text: emailBody.innerHTML,
      mode
    }),
  });

  const data = await response.json();
  if (data.rewritten) {
    emailBody.innerHTML = data.rewritten;
  } else {
    alert("Rewrite failed.");
  }
});

/* ---------------------------------------
   SAVE TEMPLATES (LocalStorage)
--------------------------------------- */
const STORAGE_KEY = "email_templates_saved_v1";

function loadSaved() {
  return JSON.parse(localStorage.getItem(STORAGE_KEY) || "{}");
}

function saveToStorage(obj) {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(obj));
}

let savedTemplates = loadSaved();
updateSavedSelect();

function updateSavedSelect() {
  savedSelect.innerHTML = `<option value="">(none)</option>`;
  Object.keys(savedTemplates).forEach(name => {
    const opt = document.createElement("option");
    opt.value = name;
    opt.textContent = name;
    savedSelect.appendChild(opt);
  });
}

saveCurrentBtn.addEventListener("click", () => {
  const name = prompt("Name this version:");
  if (!name) return;

  savedTemplates[name] = {
    to: toField.value,
    subject: subjectField.value,
    body: emailBody.innerHTML
  };

  saveToStorage(savedTemplates);
  updateSavedSelect();
  alert("Saved!");
});

deleteSavedBtn.addEventListener("click", () => {
  const key = savedSelect.value;
  if (!key) return;

  delete savedTemplates[key];
  saveToStorage(savedTemplates);
  updateSavedSelect();
});

/* LOAD SELECTED TEMPLATE */
savedSelect.addEventListener("change", () => {
  const key = savedSelect.value;
  if (!key) return;

  const data = savedTemplates[key];
  toField.value = data.to || "";
  subjectField.value = data.subject || "";
  emailBody.innerHTML = data.body || "";
});

/* ---------------------------------------
   COPY EMAIL
--------------------------------------- */
function getPlainText() {
  const lines = [];

  if (toField.value.trim()) lines.push("To: " + toField.value.trim());
  if (subjectField.value.trim()) lines.push("Subject: " + subjectField.value.trim());
  if (lines.length) lines.push("");

  lines.push(emailBody.innerText);
  return lines.join("\n");
}

copyBtn.addEventListener("click", async () => {
  const missing = getUnfilledPlaceholders();

  if (missing.length > 0) {
    missing.forEach(el => el.classList.add("placeholder-warning"));

    alert(
      `You still have ${missing.length} unfilled placeholder(s).\n` +
      `Please fill them in before copying.`
    );

    setTimeout(() => {
      missing.forEach(el => el.classList.remove("placeholder-warning"));
    }, 2000);

    missing[0].focus();
    return;
  }

  const text = getPlainText();
  await navigator.clipboard.writeText(text);

  copyBtn.textContent = "Copied!";
  setTimeout(() => (copyBtn.textContent = "Copy Email"), 1500);
});


/* ---------------------------------------
   CLEAR FIELDS
--------------------------------------- */
clearBtn.addEventListener("click", () => {
  toField.value = "";
  subjectField.value = "";
  extraFields.classList.add("hidden");
  setTone("friendly");
});
</script>

</body>
</html>
